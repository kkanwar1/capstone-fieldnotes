<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Capstone 2025 Field Notes</title>

    <!-- Tailwind (utility classes) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + ReactDOM (UMD) + Babel (so we can write JSX right here) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      .input {
        width: 100%;
        border-radius: 0.75rem;
        border: 1px solid rgb(209 213 219);
        background: #fff;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        outline: none;
      }
      .input:focus { box-shadow: 0 0 0 3px rgba(0,0,0,0.06); }
      .btn {
        display: inline-flex; align-items: center; gap: 0.5rem;
        border-radius: 0.75rem; border: 1px solid rgb(31 41 55);
        background: rgb(17 24 39); color: #fff;
        padding: 0.5rem 0.75rem; font-size: 0.875rem; font-weight: 500;
      }
      .btn:hover { background: #000; }
      .btn-danger { border-color: rgb(185 28 28); background: rgb(185 28 28); }
      .btn-danger:hover { background: rgb(153 27 27); }
      .btn-xs { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.5rem; }
      .tabular-nums { font-variant-numeric: tabular-nums; }
      .icon { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;

      const STORAGE_KEY = "fieldnotes_jobs_v1";
      const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : ("id-" + Math.random().toString(16).slice(2)));

      const EMPTY_JOB = () => ({
        id: uuid(),
        name: "Untitled Job",
        date: new Date().toISOString().slice(0, 10),
        crew: "",
        instrument: "",
        notes: "",
        stations: [],
        observations: [],
        level_loops: [],
        level_legs: [],
        // NEW: persisted traverse path (ordered station codes)
        traverse_path: [],
      });

      const clampNum = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
      const wrap360 = (deg) => {
        let d = deg % 360;
        if (d < 0) d += 360;
        return d;
      };

      const dmsToDecimal = (d, m, s, sign = 1) => {
        const dd = Math.abs(Number(d) || 0);
        const mm = Math.abs(Number(m) || 0);
        const ss = Math.abs(Number(s) || 0);
        return sign * (dd + mm / 60 + ss / 3600);
      };

      const decimalToDMS = (deg) => {
        const sign = deg < 0 ? -1 : 1;
        let d = Math.abs(deg);
        const D = Math.floor(d);
        d = (d - D) * 60;
        const M = Math.floor(d);
        const S = (d - M) * 60;
        return { sign, d: String(D), m: String(M), s: S.toFixed(6) };
      };

      const OBSERVATION_COLUMNS = [
        "station_code","target_code","round_id","face","hz_deg","z_deg","slope_m","ih_m","th_m","timestamp","notes",
      ];

      const toCsvWithColumns = (rows, columns) => {
        const head = columns.join(",");
        const body = rows
          .map((r) =>
            columns
              .map((k) => (r[k] ?? "").toString().replaceAll('"', '""'))
              .map((v) => `"${v}"`)
              .join(",")
          )
          .join("\n");
        return head + "\n" + body;
      };

      const toCsv = (rows) => toCsvWithColumns(rows, OBSERVATION_COLUMNS);

      function Field({ label, children, required = false, hint }) {
        return (
          <label className="flex flex-col gap-1 text-sm">
            <span className="font-medium text-gray-800">
              {label}{required && <span className="text-red-600"> *</span>}
            </span>
            {children}
            {hint && <span className="text-xs text-gray-500">{hint}</span>}
          </label>
        );
      }
        
      function Section({ title, children, right }) {
        return (
          <section className="bg-white/60 backdrop-blur rounded-2xl shadow p-4 md:p-6 border border-gray-200">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg md:text-xl font-semibold">{title}</h2>
              {right}
            </div>
            {children}
          </section>
        );
      }

      function FieldNotesApp() {
        const [jobs, setJobs] = useState(() => {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            const parsed = raw ? JSON.parse(raw) : [];
            return Array.isArray(parsed) ? parsed : [];
          } catch { return []; }
        });
        const [activeJobId, setActiveJobId] = useState(() => jobs[0]?.id);
        const activeJob = useMemo(() => jobs.find(j => j.id === activeJobId), [jobs, activeJobId]);

        useEffect(() => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs));
        }, [jobs]);

        const newJob = () => {
          const j = EMPTY_JOB();
          setJobs(prev => [j, ...prev]);
          setActiveJobId(j.id);
        };

        const updateJob = (patch) => {
          if (!activeJob) return;
          setJobs(prev => prev.map(j => j.id === activeJob.id ? { ...j, ...patch } : j));
        };

        const deleteJob = (id) => {
          setJobs(prev => prev.filter(j => j.id !== id));
          if (activeJobId === id) {
            const next = jobs.find(j => j.id !== id)?.id;
            setActiveJobId(next);
          }
        };

        const [tab, setTab] = useState("obs"); // "stations" | "obs" | "levelling" | "review"
        const [angleMode, setAngleMode] = useState("decimal"); // or "dms"

        // Station form (with initial bearing decimal + DMS boxes)
        const [stationForm, setStationForm] = useState({
          code: "", e: "", n: "", h: "", ih: "",
          initial_bearing_deg: "",
          ib_d: "", ib_m: "", ib_s: "", ib_sign: 1,
        });

        // Prefill DMS boxes when toggling
        useEffect(() => {
          if (angleMode === "dms" && stationForm.initial_bearing_deg !== "") {
            const val = Number(stationForm.initial_bearing_deg);
            if (isFinite(val)) {
              const dms = decimalToDMS(wrap360(val));
              setStationForm(f => ({ ...f, ib_d: dms.d, ib_m: dms.m, ib_s: dms.s, ib_sign: dms.sign }));
            }
          }
        }, [angleMode]); // eslint-disable-line

        const addStation = () => {
          if (!activeJob) return;
          if (!stationForm.code.trim()) return alert("Station code is required");

          let initial_bearing_deg = null;
          if (angleMode === "dms") {
            const val = dmsToDecimal(stationForm.ib_d, stationForm.ib_m, stationForm.ib_s, stationForm.ib_sign || 1);
            if (isFinite(val)) initial_bearing_deg = wrap360(val);
          } else if (stationForm.initial_bearing_deg !== "") {
            const val = Number(stationForm.initial_bearing_deg);
            if (isFinite(val)) initial_bearing_deg = wrap360(val);
          }

          const st = {
            id: uuid(),
            code: stationForm.code.trim(),
            e: stationForm.e ? Number(stationForm.e) : null,
            n: stationForm.n ? Number(stationForm.n) : null,
            h: stationForm.h ? Number(stationForm.h) : null,
            ih: stationForm.ih ? Number(stationForm.ih) : null,
            initial_bearing_deg,
            timestamp: new Date().toISOString(),
          };
          updateJob({ stations: [st, ...(activeJob.stations || [])] });
          setStationForm({ code: "", e: "", n: "", h: "", ih: "", initial_bearing_deg: "", ib_d: "", ib_m: "", ib_s: "", ib_sign: 1 });
        };

        // Observation form
        const [obsForm, setObsForm] = useState({
          station_code: "",
          target_code: "",
          round_id: "1",
          face: "FL",
          hz: { decimal: "", d: "", m: "", s: "", sign: 1 },
          z:  { decimal: "", d: "", m: "", s: "", sign: 1 },
          slope_m: "",
          ih_m: "",
          th_m: "",
          timestamp: new Date().toISOString().slice(0,19),
          notes: "",
        });

        const dmsControls = (key) => (
          <div className="flex items-end gap-2">
            <Field label="°">
              <input type="number" inputMode="numeric" className="w-20 input"
                value={obsForm[key].d}
                onChange={(e) => setObsForm(f => ({ ...f, [key]: { ...f[key], d: e.target.value } }))}/>
            </Field>
            <Field label="′">
              <input type="number" inputMode="numeric" className="w-20 input"
                value={obsForm[key].m}
                onChange={(e) => setObsForm(f => ({ ...f, [key]: { ...f[key], m: e.target.value } }))}/>
            </Field>
            <Field label="″">
              <input type="number" inputMode="decimal" className="w-24 input"
                value={obsForm[key].s}
                onChange={(e) => setObsForm(f => ({ ...f, [key]: { ...f[key], s: e.target.value } }))}/>
            </Field>
          </div>
        );

        const parseAngle = (obj) => {
          if (angleMode === "decimal") return Number(obj.decimal || 0);
          return dmsToDecimal(obj.d, obj.m, obj.s, obj.sign);
        };

        const addObservation = () => {
          if (!activeJob) return;
          if (!obsForm.station_code.trim() || !obsForm.target_code.trim()) {
            return alert("Station and Target codes are required");
          }
          const hz_deg = wrap360(parseAngle(obsForm.hz));
          const z_deg  = clampNum(parseAngle(obsForm.z), -360, 360);

          const record = {
            id: uuid(),
            station_code: obsForm.station_code.trim(),
            target_code: obsForm.target_code.trim(),
            round_id: obsForm.round_id.trim(),
            face: obsForm.face,
            hz_deg,
            z_deg,
            slope_m: obsForm.slope_m ? Number(obsForm.slope_m) : null,
            ih_m: obsForm.ih_m ? Number(obsForm.ih_m) : null,
            th_m: obsForm.th_m ? Number(obsForm.th_m) : null,
            timestamp: obsForm.timestamp,
            notes: obsForm.notes,
          };

          updateJob({ observations: [record, ...(activeJob.observations || [])] });
          setObsForm({ ...obsForm, target_code: "", slope_m: "", notes: "" });
        };

        const deleteObservation = (id) => {
          if (!activeJob) return;
          updateJob({ observations: activeJob.observations.filter(o => o.id !== id) });
        };

        // Levelling forms (unchanged) ...
        const [levelLoopForm, setLevelLoopForm] = useState({
          loop_code: "",
          start_control: "",
          start_elev_m: "",
          end_control: "",
          end_elev_known_m: "",
          date: new Date().toISOString().slice(0,10),
          notes: "",
        });

        const addLevelLoop = () => {
          if (!activeJob) return;
          if (!levelLoopForm.loop_code.trim()) return alert("Loop code is required");
          const loop = {
            id: uuid(),
            loop_code: levelLoopForm.loop_code.trim(),
            start_control: levelLoopForm.start_control.trim(),
            start_elev_m: levelLoopForm.start_elev_m ? Number(levelLoopForm.start_elev_m) : null,
            end_control: levelLoopForm.end_control.trim(),
            end_elev_known_m: levelLoopForm.end_elev_known_m ? Number(levelLoopForm.end_elev_known_m) : null,
            date: levelLoopForm.date,
            notes: levelLoopForm.notes,
          };
          updateJob({ level_loops: [loop, ...(activeJob.level_loops || [])] });
          setLevelLoopForm({
            loop_code: "", start_control: "", start_elev_m: "", end_control: "",
            end_elev_known_m: "", date: new Date().toISOString().slice(0,10), notes: "",
          });
          setSelectedLoopId(loop.id);
        };

        const [selectedLoopId, setSelectedLoopId] = useState("");
        const [levelLegForm, setLevelLegForm] = useState({
          loop_id: "",
          leg_no: "1",
          from_point: "",
          to_point: "",
          bs_m: "",
          fs_m: "",
          timestamp: new Date().toISOString().slice(0,19),
          notes: "",
        });

        const addLevelLeg = () => {
          if (!activeJob) return;
          const loop_id = selectedLoopId || levelLegForm.loop_id;
          if (!loop_id) return alert("Select a loop first");
          if (!levelLegForm.from_point.trim() || !levelLegForm.to_point.trim())
            return alert("From and To points are required");

          const bs = levelLegForm.bs_m ? Number(levelLegForm.bs_m) : NaN;
          const fs = levelLegForm.fs_m ? Number(levelLegForm.fs_m) : NaN;
          const delta_h = (isNaN(bs) || isNaN(fs)) ? null : (bs - fs);

          const leg = {
            id: uuid(),
            loop_id,
            leg_no: levelLegForm.leg_no.trim(),
            from_point: levelLegForm.from_point.trim(),
            to_point: levelLegForm.to_point.trim(),
            bs_m: isNaN(bs) ? null : bs,
            fs_m: isNaN(fs) ? null : fs,
            delta_h_m: delta_h,
            timestamp: levelLegForm.timestamp,
            notes: levelLegForm.notes,
          };
          updateJob({ level_legs: [leg, ...(activeJob.level_legs || [])] });
          setLevelLegForm({
            loop_id, leg_no: (Number(levelLegForm.leg_no || "1") + 1).toString(),
            from_point: "", to_point: "", bs_m: "", fs_m: "",
            timestamp: new Date().toISOString().slice(0,19), notes: "",
          });
        };

        const deleteLevelLeg = (id) => {
          if (!activeJob) return;
          updateJob({ level_legs: activeJob.level_legs.filter(l => l.id !== id) });
        };

        const currentLoop = useMemo(() => {
          if (!activeJob) return null;
          return (activeJob.level_loops || []).find(l => l.id === selectedLoopId) || null;
        }, [activeJob, selectedLoopId]);

        const legsForCurrentLoop = useMemo(() => {
          if (!activeJob || !selectedLoopId) return [];
          return (activeJob.level_legs || [])
            .filter(l => l.loop_id === selectedLoopId)
            .sort((a,b) => Number(a.leg_no||0) - Number(b.leg_no||0));
        }, [activeJob, selectedLoopId]);

        const loopTotals = useMemo(() => {
          const sum_dh = legsForCurrentLoop.reduce((acc, l) => acc + (Number(l.delta_h_m) || 0), 0);
          const startElev = currentLoop?.start_elev_m ?? null;
          const computedEnd = (startElev != null && isFinite(startElev)) ? (startElev + sum_dh) : null;
          const knownEnd = currentLoop?.end_elev_known_m ?? null;
          const closure = (computedEnd != null && knownEnd != null) ? (computedEnd - knownEnd) : null;
          return { sum_dh, computedEnd, knownEnd, closure };
        }, [legsForCurrentLoop, currentLoop]);

        // ---------- NEW: Traverse Path (closed loop) ----------
        const traversePath = activeJob?.traverse_path || [];
        const [traverseInput, setTraverseInput] = useState("");

        const setTraversePath = (arr) => updateJob({ traverse_path: arr });

        const addTraverseStation = () => {
          if (!activeJob) return;
          const code = (traverseInput || "").trim();
          if (!code) return;
          setTraversePath([...(traversePath || []), code]);
          setTraverseInput("");
        };

        const removeTraverseIndex = (idx) => {
          const next = [...traversePath];
          next.splice(idx, 1);
          setTraversePath(next);
        };

        const moveTraverseUp = (idx) => {
          if (idx <= 0) return;
          const next = [...traversePath];
          [next[idx-1], next[idx]] = [next[idx], next[idx-1]];
          setTraversePath(next);
        };

        const moveTraverseDown = (idx) => {
          if (idx >= traversePath.length - 1) return;
          const next = [...traversePath];
          [next[idx+1], next[idx]] = [next[idx], next[idx+1]];
          setTraversePath(next);
        };

        const clearTraversePath = () => setTraversePath([]);

        const exportTraverseNodesCSV = () => {
          if (!activeJob) return;
          const path = traversePath || [];
          if (path.length < 2) {
            alert("Add at least two stations to define a closed path.");
            return;
          }
          // Auto-close the loop by repeating first at the end if not already closed
          const closed = (path[0] === path[path.length - 1]);
          const out = closed ? path.slice() : [...path, path[0]];

          const rows = out.map((code, i) => ({ seq: i + 1, station_code: code }));
          const csv = toCsvWithColumns(rows, ["seq","station_code"]);
          const fname = `${(activeJob.name || "job").replaceAll(" ","_")}_traverse_nodes.csv`;
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = fname; a.click();
          URL.revokeObjectURL(url);
        };
        // ------------------------------------------------------

        const exportJSON = () => {
          if (!activeJob) return;
          const fname = `${(activeJob.name || "job").replaceAll(" ","_")}_observations.json`;
          const blob = new Blob([JSON.stringify(activeJob, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = fname; a.click();
          URL.revokeObjectURL(url);
        };

        const exportCSV = () => {
          if (!activeJob) return;
          const fname = `${(activeJob.name || "job").replaceAll(" ","_")}_observations.csv`;
          const csv = toCsv(activeJob.observations || []);
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = fname; a.click();
          URL.revokeObjectURL(url);
        };

        const exportLevelLoopsCSV = () => {
          if (!activeJob) return;
          const cols = ["loop_code","date","start_control","start_elev_m","end_control","end_elev_known_m","notes"];
          const rows = (activeJob.level_loops || []).map(l => ({
            loop_code: l.loop_code || "",
            date: l.date || "",
            start_control: l.start_control || "",
            start_elev_m: l.start_elev_m ?? "",
            end_control: l.end_control || "",
            end_elev_known_m: l.end_elev_known_m ?? "",
            notes: l.notes || "",
          }));
          const csv = toCsvWithColumns(rows, cols);
          const fname = `${(activeJob.name || "job").replaceAll(" ","_")}_level_loops.csv`;
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = fname; a.click();
          URL.revokeObjectURL(url);
        };

        const exportLevelLegsCSV = () => {
          if (!activeJob) return;
          const loopCodeById = Object.fromEntries((activeJob.level_loops || []).map(l => [l.id, l.loop_code]));
          const cols = ["loop_id","loop_code","leg_no","from_point","to_point","bs_m","fs_m","delta_h_m","timestamp","notes"];
          const rows = (activeJob.level_legs || []).map(l => ({
            loop_id: l.loop_id || "",
            loop_code: loopCodeById[l.loop_id] || "",
            leg_no: l.leg_no || "",
            from_point: l.from_point || "",
            to_point: l.to_point || "",
            bs_m: l.bs_m ?? "",
            fs_m: l.fs_m ?? "",
            delta_h_m: l.delta_h_m ?? "",
            timestamp: l.timestamp || "",
            notes: l.notes || "",
          }));
          const csv = toCsvWithColumns(rows, cols);
          const fname = `${(activeJob.name || "job").replaceAll(" ","_")}_level_legs.csv`;
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = fname; a.click();
          URL.revokeObjectURL(url);
        };

        return (
          <div className="max-w-6xl mx-auto p-4 md:p-6">
            {/* Header */}
            <header className="flex flex-col md:flex-row gap-3 md:gap-4 items-start md:items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-2xl bg-black/90 text-white grid place-items-center font-bold">FN</div>
                <div>
                  <h1 className="text-xl md:text-2xl font-semibold">Capstone 2025 Field Notes</h1>
                  <p className="text-xs md:text-sm text-gray-600">Mobile + desktop data entry for survey observations</p>
                </div>
              </div>
              <div className="flex flex-wrap items-center gap-2">
                <button className="btn" onClick={newJob}>New Job</button>
                <select className="input" value={activeJobId || ""} onChange={(e) => setActiveJobId(e.target.value)}>
                  <option value="" disabled>Select job</option>
                  {jobs.map(j => (<option key={j.id} value={j.id}>{j.name} — {j.date}</option>))}
                </select>
                {activeJob && (
                  <button className="btn btn-danger" onClick={() => deleteJob(activeJob.id)}>Delete Job</button>
                )}
              </div>
            </header>

            {/* Job metadata + tabs */}
            {activeJob && (
              <Section
                title="Job metadata"
                right={
                  <div className="flex items-center gap-2">
                    <label className="text-sm text-gray-600">Angles:</label>
                    <select className="input w-36" value={angleMode} onChange={(e) => setAngleMode(e.target.value)}>
                      <option value="decimal">Decimal °</option>
                      <option value="dms">DMS (° ′ ″)</option>
                    </select>
                  </div>
                }
              >
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                  <Field label="Job name" required>
                    <input className="input" placeholder="e.g., Kananaskis Traverse A"
                      value={activeJob.name} onChange={(e) => updateJob({ name: e.target.value })} />
                  </Field>
                  <Field label="Date" required>
                    <input type="date" className="input" value={activeJob.date}
                      onChange={(e) => updateJob({ date: e.target.value })} />
                  </Field>
                  <Field label="Crew">
                    <input className="input" placeholder="e.g., Alex, Priya"
                      value={activeJob.crew} onChange={(e) => updateJob({ crew: e.target.value })} />
                  </Field>
                  <Field label="Instrument">
                    <input className="input" placeholder="e.g., Lecia / Trimble"
                      value={activeJob.instrument} onChange={(e) => updateJob({ instrument: e.target.value })} />
                  </Field>
                </div>
                <div className="mt-3">
                  <Field label="Notes">
                    <textarea className="input" rows="2" placeholder="Optional project notes"
                      value={activeJob.notes} onChange={(e) => updateJob({ notes: e.target.value })}></textarea>
                  </Field>
                </div>

                <div className="mt-6 border-b border-gray-200 flex gap-1">
                  {[
                    ["stations","Stations"],
                    ["obs","Observations"],
                    ["levelling","Levelling"],
                    ["review","Review & Export"],
                  ].map(([key, label]) => (
                    <button
                      key={key}
                      className={`px-3 py-2 text-sm rounded-t-lg border border-b-0 ${tab===key ? "bg-white" : "bg-gray-100 hover:bg-white"}`}
                      onClick={() => setTab(key)}
                    >{label}</button>
                  ))}
                </div>
              </Section>
            )}

            {/* Stations */}
            {activeJob && tab === "stations" && (
              <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
                <Section title="Add station">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <Field label="Code" required>
                      <input className="input" value={stationForm.code}
                        onChange={(e) => setStationForm(f => ({ ...f, code: e.target.value }))} />
                    </Field>
                    <Field label="Instrument Height (IH, m)">
                      <input type="number" inputMode="decimal" className="input" value={stationForm.ih}
                        onChange={(e) => setStationForm(f => ({ ...f, ih: e.target.value }))} />
                    </Field>
                    <Field label="Easting (m)">
                      <input type="number" inputMode="decimal" className="input" value={stationForm.e}
                        onChange={(e) => setStationForm(f => ({ ...f, e: e.target.value }))} />
                    </Field>
                    <Field label="Northing (m)">
                      <input type="number" inputMode="decimal" className="input" value={stationForm.n}
                        onChange={(e) => setStationForm(f => ({ ...f, n: e.target.value }))} />
                    </Field>
                    <Field label="Elevation (m)">
                      <input type="number" inputMode="decimal" className="input" value={stationForm.h}
                        onChange={(e) => setStationForm(f => ({ ...f, h: e.target.value }))} />
                    </Field>

                    {/* Initial bearing (decimal or DMS) */}
                    <div className="md:col-span-2">
                      <span className="text-sm font-medium text-gray-800">Initial bearing (azimuth of first observation)</span>
                      <div className="mt-1">
                        {angleMode === "decimal" ? (
                          <Field hint="Decimal 0–360°; used later for orientation corrections">
                            <input
                              type="number"
                              inputMode="decimal"
                              className="input"
                              placeholder="e.g., 217.418"
                              value={stationForm.initial_bearing_deg}
                              onChange={(e) => setStationForm(f => ({ ...f, initial_bearing_deg: e.target.value }))}
                            />
                          </Field>
                        ) : (
                          <div className="flex items-end gap-2">
                            <Field label="°"><input type="number" inputMode="numeric" className="w-20 input"
                              value={stationForm.ib_d}
                              onChange={(e) => setStationForm(f => ({ ...f, ib_d: e.target.value }))} /></Field>
                            <Field label="′"><input type="number" inputMode="numeric" className="w-20 input"
                              value={stationForm.ib_m}
                              onChange={(e) => setStationForm(f => ({ ...f, ib_m: e.target.value }))} /></Field>
                            <Field label="″"><input type="number" inputMode="decimal" className="w-24 input"
                              value={stationForm.ib_s}
                              onChange={(e) => setStationForm(f => ({ ...f, ib_s: e.target.value }))} /></Field>
                          </div>
                        )}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">Stored as decimal degrees; normalized to [0, 360).</div>
                    </div>
                  </div>
                  <div className="mt-4 flex justify-end">
                    <button className="btn" onClick={addStation}>Add Station</button>
                  </div>
                </Section>

                <Section title="Stations list" right={<span className="text-sm text-gray-500">{activeJob.stations.length} total</span>}>
                  {activeJob.stations.length === 0 ? (
                    <p className="text-sm text-gray-600">No stations yet.</p>
                  ) : (
                    <div className="overflow-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="text-left text-gray-600">
                            <th className="p-2">Code</th>
                            <th className="p-2">IH (m)</th>
                            <th className="p-2">E</th>
                            <th className="p-2">N</th>
                            <th className="p-2">H</th>
                          </tr>
                        </thead>
                        <tbody>
                          {activeJob.stations.map(s => (
                            <tr key={s.id} className="border-t">
                              <td className="p-2 font-medium">{s.code}</td>
                              <td className="p-2">{s.ih ?? ""}</td>
                              <td className="p-2">{s.e ?? ""}</td>
                              <td className="p-2">{s.n ?? ""}</td>
                              <td className="p-2">{s.h ?? ""}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </Section>

                <Section title="Tips">
                  <ul className="list-disc pl-5 text-sm text-gray-700 space-y-2">
                    <li>Stations can omit E/N/H if unknown at entry time.</li>
                    <li>Use the Observations tab to add FL/FR rounds to targets.</li>
                    <li>All data is saved locally on this device (no server yet).</li>
                  </ul>
                </Section>
              </div>
            )}

            {/* Observations */}
            {activeJob && tab === "obs" && (
              <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
                <Section title="Add observation">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <Field label="Station code" required>
                      <input className="input" list="stations" value={obsForm.station_code}
                        onChange={(e) => setObsForm(f => ({ ...f, station_code: e.target.value }))} />
                      <datalist id="stations">
                        {(activeJob.stations || []).map(s => <option key={s.id} value={s.code} />)}
                      </datalist>
                    </Field>
                    <Field label="Target code" required>
                      <input className="input" value={obsForm.target_code}
                        onChange={(e) => setObsForm(f => ({ ...f, target_code: e.target.value }))} />
                    </Field>
                    <Field label="Round #">
                      <input type="number" inputMode="numeric" className="input" value={obsForm.round_id}
                        onChange={(e) => setObsForm(f => ({ ...f, round_id: e.target.value }))} />
                    </Field>
                    <Field label="Face">
                      <select className="input" value={obsForm.face}
                        onChange={(e) => setObsForm(f => ({ ...f, face: e.target.value }))}>
                        <option>FL</option><option>FR</option>
                      </select>
                    </Field>

                    {/* Hz */}
                    <div className="md:col-span-2">
                      <span className="text-sm font-medium text-gray-800">Horizontal angle (Hz)</span>
                      <div className="mt-1">
                        {angleMode === "decimal" ? (
                          <input type="number" inputMode="decimal" placeholder="Decimal degrees"
                            className="input w-full" value={obsForm.hz.decimal}
                            onChange={(e) => setObsForm(f => ({ ...f, hz: { ...f.hz, decimal: e.target.value } }))} />
                        ) : ( dmsControls("hz") )}
                      </div>
                    </div>

                    {/* Z */}
                    <div className="md:col-span-2">
                      <span className="text-sm font-medium text-gray-800">Zenith angle (Z)</span>
                      <div className="mt-1">
                        {angleMode === "decimal" ? (
                          <input type="number" inputMode="decimal" placeholder="Decimal degrees"
                            className="input w-full" value={obsForm.z.decimal}
                            onChange={(e) => setObsForm(f => ({ ...f, z: { ...f.z, decimal: e.target.value } }))} />
                        ) : ( dmsControls("z") )}
                      </div>
                    </div>

                    <Field label="Slope distance (m)">
                      <input type="number" inputMode="decimal" className="input" value={obsForm.slope_m}
                        onChange={(e) => setObsForm(f => ({ ...f, slope_m: e.target.value }))} />
                    </Field>
                    <Field label="Instrument height IH (m)">
                      <input type="number" inputMode="decimal" className="input" value={obsForm.ih_m}
                        onChange={(e) => setObsForm(f => ({ ...f, ih_m: e.target.value }))} />
                    </Field>
                    <Field label="Target height TH (m)">
                      <input type="number" inputMode="decimal" className="input" value={obsForm.th_m}
                        onChange={(e) => setObsForm(f => ({ ...f, th_m: e.target.value }))} />
                    </Field>
                    <Field label="Timestamp">
                      <input type="datetime-local" className="input" value={obsForm.timestamp}
                        onChange={(e) => setObsForm(f => ({ ...f, timestamp: e.target.value }))} />
                    </Field>
                    <Field label="Notes">
                      <input className="input" value={obsForm.notes}
                        onChange={(e) => setObsForm(f => ({ ...f, notes: e.target.value }))} />
                    </Field>
                  </div>
                  <div className="mt-4 flex justify-end">
                    <button className="btn" onClick={addObservation}>Add Observation</button>
                  </div>
                </Section>

                <Section title="Observations" right={<span className="text-sm text-gray-500">{activeJob.observations.length} total</span>}>
                  {activeJob.observations.length === 0 ? (
                    <p className="text-sm text-gray-600">No observations yet.</p>
                  ) : (
                    <div className="overflow-auto max-h-[520px]">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="text-left text-gray-600">
                            <th className="p-2">Station</th>
                            <th className="p-2">Target</th>
                            <th className="p-2">Rnd</th>
                            <th className="p-2">Face</th>
                            <th className="p-2">Hz (°)</th>
                            <th className="p-2">Z (°)</th>
                            <th className="p-2">Slope (m)</th>
                            <th className="p-2">IH</th>
                            <th className="p-2">TH</th>
                            <th className="p-2">Time</th>
                            <th className="p-2"></th>
                          </tr>
                        </thead>
                        <tbody>
                          {activeJob.observations.map(o => (
                            <tr key={o.id} className="border-t hover:bg-gray-50">
                              <td className="p-2 font-medium">{o.station_code}</td>
                              <td className="p-2">{o.target_code}</td>
                              <td className="p-2">{o.round_id}</td>
                              <td className="p-2">{o.face}</td>
                              <td className="p-2 tabular-nums">{o.hz_deg?.toFixed?.(6)}</td>
                              <td className="p-2 tabular-nums">{o.z_deg?.toFixed?.(6)}</td>
                              <td className="p-2">{o.slope_m ?? ""}</td>
                              <td className="p-2">{o.ih_m ?? ""}</td>
                              <td className="p-2">{o.th_m ?? ""}</td>
                              <td className="p-2 whitespace-nowrap">{o.timestamp?.replace("T"," ")}</td>
                              <td className="p-2 text-right">
                                <button className="btn btn-danger btn-xs" onClick={() => deleteObservation(o.id)}>Delete</button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </Section>

                <Section title="Quick help">
                  <ul className="list-disc pl-5 text-sm text-gray-700 space-y-2">
                    <li>Enter Hz and Z as decimal degrees or switch to DMS at the top.</li>
                    <li>Hz is normalized to [0, 360).</li>
                    <li>Use rounds and faces (FL/FR) like your field workflow.</li>
                  </ul>
                </Section>
              </div>
            )}

            {/* Levelling */}
            {activeJob && tab === "levelling" && (
              <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
                <Section title="Levelling loop setup">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <Field label="Loop code" required>
                      <input className="input" placeholder="e.g., Loop-1"
                        value={levelLoopForm.loop_code}
                        onChange={(e) => setLevelLoopForm(f => ({ ...f, loop_code: e.target.value }))} />
                    </Field>
                    <Field label="Date">
                      <input type="date" className="input" value={levelLoopForm.date}
                        onChange={(e) => setLevelLoopForm(f => ({ ...f, date: e.target.value }))} />
                    </Field>
                    <Field label="Start control code">
                      <input className="input" placeholder="e.g., BM-01"
                        value={levelLoopForm.start_control}
                        onChange={(e) => setLevelLoopForm(f => ({ ...f, start_control: e.target.value }))} />
                    </Field>
                    <Field label="Start elevation (m)">
                      <input type="number" inputMode="decimal" className="input" placeholder="optional"
                        value={levelLoopForm.start_elev_m}
                        onChange={(e) => setLevelLoopForm(f => ({ ...f, start_elev_m: e.target.value }))} />
                    </Field>
                    <Field label="End control code">
                      <input className="input" placeholder="e.g., BM-02"
                        value={levelLoopForm.end_control}
                        onChange={(e) => setLevelLoopForm(f => ({ ...f, end_control: e.target.value }))} />
                    </Field>
                    <Field label="Known end elevation (m)">
                      <input type="number" inputMode="decimal" className="input" placeholder="optional"
                        value={levelLoopForm.end_elev_known_m}
                        onChange={(e) => setLevelLoopForm(f => ({ ...f, end_elev_known_m: e.target.value }))} />
                    </Field>
                    <div className="md:col-span-2">
                      <Field label="Notes">
                        <textarea className="input" rows="2" placeholder="Optional loop notes"
                          value={levelLoopForm.notes}
                          onChange={(e) => setLevelLoopForm(f => ({ ...f, notes: e.target.value }))}></textarea>
                      </Field>
                    </div>
                  </div>
                  <div className="mt-4 flex justify-end">
                    <button className="btn" onClick={addLevelLoop}>Add loop</button>
                  </div>
                </Section>

                <Section
                  title="Loops"
                  right={
                    <select className="input" value={selectedLoopId} onChange={(e)=>setSelectedLoopId(e.target.value)}>
                      <option value="">Select loop</option>
                      {(activeJob.level_loops || []).map(l =>
                        <option key={l.id} value={l.id}>{l.loop_code}</option>
                      )}
                    </select>
                  }
                >
                  {(activeJob.level_loops || []).length === 0 ? (
                    <p className="text-sm text-gray-600">No loops yet.</p>
                  ) : (
                    <div className="overflow-auto max-h-[520px]">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="text-left text-gray-600">
                            <th className="p-2">Loop</th>
                            <th className="p-2">Start</th>
                            <th className="p-2">Start Elev</th>
                            <th className="p-2">End</th>
                            <th className="p-2">End Elev (known)</th>
                            <th className="p-2">Date</th>
                          </tr>
                        </thead>
                        <tbody>
                          {(activeJob.level_loops || []).map(l => (
                            <tr key={l.id} className="border-t">
                              <td className="p-2 font-medium">{l.loop_code}</td>
                              <td className="p-2">{l.start_control || "—"}</td>
                              <td className="p-2">{l.start_elev_m ?? "—"}</td>
                              <td className="p-2">{l.end_control || "—"}</td>
                              <td className="p-2">{l.end_elev_known_m ?? "—"}</td>
                              <td className="p-2">{l.date}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </Section>

                <Section title="Add level leg">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <Field label="Loop">
                      <select className="input" value={selectedLoopId} onChange={(e)=>setSelectedLoopId(e.target.value)}>
                        <option value="">Select loop</option>
                        {(activeJob.level_loops || []).map(l =>
                          <option key={l.id} value={l.id}>{l.loop_code}</option>
                        )}
                      </select>
                    </Field>
                    <Field label="Leg #">
                      <input type="number" inputMode="numeric" className="input"
                        value={levelLegForm.leg_no}
                        onChange={(e)=>setLevelLegForm(f=>({...f, leg_no: e.target.value}))} />
                    </Field>
                    <Field label="From point" required>
                      <input className="input" placeholder="e.g., TP-01"
                        value={levelLegForm.from_point}
                        onChange={(e)=>setLevelLegForm(f=>({...f, from_point: e.target.value}))} />
                    </Field>
                    <Field label="To point" required>
                      <input className="input" placeholder="e.g., TP-02"
                        value={levelLegForm.to_point}
                        onChange={(e)=>setLevelLegForm(f=>({...f, to_point: e.target.value}))} />
                    </Field>
                    <Field label="Backsight BS (m)">
                      <input type="number" inputMode="decimal" className="input"
                        value={levelLegForm.bs_m}
                        onChange={(e)=>setLevelLegForm(f=>({...f, bs_m: e.target.value}))} />
                    </Field>
                    <Field label="Foresight FS (m)">
                      <input type="number" inputMode="decimal" className="input"
                        value={levelLegForm.fs_m}
                        onChange={(e)=>setLevelLegForm(f=>({...f, fs_m: e.target.value}))} />
                    </Field>
                    <Field label="Timestamp">
                      <input type="datetime-local" className="input"
                        value={levelLegForm.timestamp}
                        onChange={(e)=>setLevelLegForm(f=>({...f, timestamp: e.target.value}))} />
                    </Field>
                    <Field label="Notes">
                      <input className="input" value={levelLegForm.notes}
                        onChange={(e)=>setLevelLegForm(f=>({...f, notes: e.target.value}))} />
                    </Field>
                  </div>
                  <div className="mt-4 flex justify-end">
                    <button className="btn" onClick={addLevelLeg}>Add leg</button>
                  </div>
                </Section>
              </div>
            )}

            {/* Review & export */}
            {activeJob && tab === "review" && (
              <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
                <Section title="Summary">
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <div className="p-2 bg-white rounded border">Stations: <b>{activeJob.stations.length}</b></div>
                    <div className="p-2 bg-white rounded border">Observations: <b>{activeJob.observations.length}</b></div>
                    <div className="p-2 bg-white rounded border">Levelling loops: <b>{activeJob.level_loops.length}</b></div>
                    <div className="p-2 bg-white rounded border">Level legs: <b>{activeJob.level_legs.length}</b></div>
                    <div className="p-2 bg-white rounded border">Crew: <b>{activeJob.crew || "—"}</b></div>
                    <div className="p-2 bg-white rounded border">Instrument: <b>{activeJob.instrument || "—"}</b></div>
                  </div>
                </Section>

                <Section title="Export">
                  <div className="flex flex-col gap-2">
                    <button className="btn" onClick={exportJSON}>Export full job (JSON)</button>
                    <button className="btn" onClick={exportCSV}>Export observations (CSV)</button>
                    <button className="btn" onClick={exportLevelLoopsCSV}>Export levelling loops (CSV)</button>
                    <button className="btn" onClick={exportLevelLegsCSV}>Export levelling legs (CSV)</button>
                  </div>
                  <p className="text-xs text-gray-500 mt-3">Observation CSV columns: {OBSERVATION_COLUMNS.join(", ")}</p>
                </Section>

                <Section title="What’s next?">
                  <ol className="list-decimal pl-5 text-sm text-gray-700 space-y-2">
                    <li>OCR intake (photo → fields).</li>
                    <li>FastAPI backend for multi-device sync.</li>
                    <li>Analysis tab (FL/FR pairing, stats, QC) + levelling checks + reports.</li>
                  </ol>
                </Section>

                {/* NEW: Traverse path (closed loop) */}
                <Section
                  title="Traverse path (closed loop)"
                  right={<span className="text-sm text-gray-500">{(activeJob.traverse_path||[]).length} in path</span>}
                >
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <Field label="Add station to path" hint="Use station codes exactly as in Stations">
                      <input className="input" list="stations_list" placeholder="e.g., TP01"
                        value={traverseInput}
                        onChange={(e)=>setTraverseInput(e.target.value)}
                        onKeyDown={(e)=>{ if(e.key==='Enter'){ addTraverseStation(); } }} />
                      <datalist id="stations_list">
                        {(activeJob.stations || []).map(s => <option key={s.id} value={s.code} />)}
                      </datalist>
                    </Field>
                    <div className="flex items-end">
                      <button className="btn" onClick={addTraverseStation}>Add</button>
                    </div>
                  </div>

                  {(traversePath || []).length === 0 ? (
                    <p className="text-sm text-gray-600 mt-3">No path yet. Add stations in order (start → … → last). We’ll repeat the first at the end on export to close the loop.</p>
                  ) : (
                    <div className="mt-3">
                      <ul className="space-y-2">
                        {traversePath.map((code, i) => (
                          <li key={`${code}-${i}`} className="flex items-center justify-between bg-white rounded border p-2">
                            <div className="text-sm"><b>{i+1}.</b> {code}</div>
                            <div className="flex items-center gap-2">
                              <button className="btn btn-xs" onClick={()=>moveTraverseUp(i)} title="Move up">↑</button>
                              <button className="btn btn-xs" onClick={()=>moveTraverseDown(i)} title="Move down">↓</button>
                              <button className="btn btn-danger btn-xs" onClick={()=>removeTraverseIndex(i)} title="Remove">Remove</button>
                            </div>
                          </li>
                        ))}
                      </ul>

                      <div className="text-xs text-gray-600 mt-2">
                        Preview: {traversePath.join(" → ")}{traversePath.length>0 ? " → " + traversePath[0] : ""}
                      </div>

                      <div className="mt-3 flex flex-wrap gap-2">
                        <button className="btn" onClick={exportTraverseNodesCSV}>Export traverse path (CSV)</button>
                        <button className="btn btn-danger" onClick={clearTraversePath}>Clear</button>
                      </div>

                      <div className="text-xs text-gray-500 mt-2">
                        Export creates <code>{(activeJob.name || "job").replaceAll(" ","_")}_traverse_nodes.csv</code> with columns <code>seq,station_code</code>. The first station is automatically repeated at the end to close the loop (if not already).
                      </div>
                      <div className="text-xs text-gray-600 mt-2">
                        Tip: for each traverse leg A→B, record an observation where <b>Station code = A</b> and <b>Target code = B</b> so ingest can match legs unambiguously.
                      </div>
                    </div>
                  )}
                </Section>
              </div>
            )}

            <footer className="mt-8 text-center text-xs text-gray-500">v1 • Local-only • Built for quick data entry on phone & desktop</footer>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<FieldNotesApp />);
    </script>
  </body>
</html>
